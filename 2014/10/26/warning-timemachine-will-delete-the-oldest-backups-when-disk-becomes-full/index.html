
<!DOCTYPE html>
<html lang="zh-CN">
    
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="阿泰的菜园">
    <title>警告：TimeMachine在磁盘爆满时将删除最旧的备份！！！ - 阿泰的菜园</title>
    <meta name="author" content="阿泰">
    
    
    
        <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
    
    <meta name="description" content="很多时候，你以为做了充分的备份，信心满满开始系统重装、磁盘格式化等等，但是等你开始想恢复备份的数据。。。天哪，备份在哪里？天哪，备份怎么读取不了了？
上周因为最新的OS X 10.10发布，准备借此机会重装一次系统，就使用了一块500G的移动硬盘，用Mac OS X内建的TimeMachine对整个笔记本操作系统做了一次全面备份。原以为这样的备份万无一失 – 这个操作系统都clone了，就再也不会">
<meta property="og:type" content="blog">
<meta property="og:title" content="警告：TimeMachine在磁盘爆满时将删除最旧的备份！！！">
<meta property="og:url" content="http://blog.huatai.me/2014/10/26/warning-timemachine-will-delete-the-oldest-backups-when-disk-becomes-full/index.html">
<meta property="og:site_name" content="阿泰的菜园">
<meta property="og:description" content="很多时候，你以为做了充分的备份，信心满满开始系统重装、磁盘格式化等等，但是等你开始想恢复备份的数据。。。天哪，备份在哪里？天哪，备份怎么读取不了了？
上周因为最新的OS X 10.10发布，准备借此机会重装一次系统，就使用了一块500G的移动硬盘，用Mac OS X内建的TimeMachine对整个笔记本操作系统做了一次全面备份。原以为这样的备份万无一失 – 这个操作系统都clone了，就再也不会">
<meta property="og:image" content="http://blog.huatai.me/img/mac/timemachine_delete_oldest_backup.png">
<meta property="og:updated_time" content="2016-02-09T14:32:52.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="警告：TimeMachine在磁盘爆满时将删除最旧的备份！！！">
<meta name="twitter:description" content="很多时候，你以为做了充分的备份，信心满满开始系统重装、磁盘格式化等等，但是等你开始想恢复备份的数据。。。天哪，备份在哪里？天哪，备份怎么读取不了了？
上周因为最新的OS X 10.10发布，准备借此机会重装一次系统，就使用了一块500G的移动硬盘，用Mac OS X内建的TimeMachine对整个笔记本操作系统做了一次全面备份。原以为这样的备份万无一失 – 这个操作系统都clone了，就再也不会">
    
    
        
    
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-ejlztp1tasruqfvoz6xmgqng0anzae8ox7cqjj5yibieqgcmhe9fwxfae6zj.min.css" type="text/css">
    <!--STYLES END-->
    
    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    

<header id="header" data-behavior="4">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <h1 class="header-title">
        <a class="header-title-link" href="/ ">阿泰的菜园</a>
    </h1>
    
        
            <a  class="header-right-picture "
                href="/#about">
        
        
        </a>
    
</header>

            <!-- Define author's picture -->


<nav id="sidebar" data-behavior="4">
    
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/ "
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-home"></i>
                    <span class="sidebar-button-desc">首頁</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/categories"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
                    <span class="sidebar-button-desc">分類</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/tags"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
                    <span class="sidebar-button-desc">標籤</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/archives"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
                    <span class="sidebar-button-desc">所有文章</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link st-search-show-outputs"
                         href="/#search"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-search"></i>
                    <span class="sidebar-button-desc">搜尋</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/#about"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-question"></i>
                    <span class="sidebar-button-desc">關於</span>
                </a>
        </li>
        
    </ul>
    
        <ul class="sidebar-buttons">
        
    </ul>
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/atom.xml"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
                    <span class="sidebar-button-desc">Atom</span>
                </a>
        </li>
        
    </ul>
    
</nav>

            
            <div id="main" data-behavior="4"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post" itemscope itemType="http://schema.org/BlogPosting">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title" itemprop="headline">
            警告：TimeMachine在磁盘爆满时将删除最旧的备份！！！
        </h1>
    
    <div class="post-meta">
    <time itemprop="datePublished" content="Sun Oct 26 2014 22:34:11 GMT+0800">
	
		    10月 26, 2014
    	
    </time>
    
</div>
</div>
    
    <div class="post-content markdown" itemprop="articleBody">
        <div class="main-content-wrap">
            <p>很多时候，你以为做了充分的备份，信心满满开始系统重装、磁盘格式化等等，但是等你开始想恢复备份的数据。。。天哪，备份在哪里？天哪，备份怎么读取不了了？</p>
<p>上周因为最新的OS X 10.10发布，准备借此机会重装一次系统，就使用了一块500G的移动硬盘，用Mac OS X内建的TimeMachine对整个笔记本操作系统做了一次全面备份。原以为这样的备份万无一失 – 这个操作系统都clone了，就再也不会有遗漏文件了。谁知道就此埋下了一个定时炸弹。。。</p>
<a id="more"></a>
<h1 id="u60B2_u5267_u7684_u53D1_u751F"><a href="#u60B2_u5267_u7684_u53D1_u751F" class="headerlink" title="悲剧的发生"></a>悲剧的发生</h1><p>这次我用于TimeMachine的移动磁盘空间只有500G，而我需要备份的笔记本电脑磁盘也是500G，经过一番数据清理以后，笔记本磁盘需要备份的数据大概有300多G，加上原先移动磁盘中的一些数据，勉强能够备份进移动硬盘的500G空间。</p>
<p>我先做了一次全面的TimeMachine备份，嗯，很好，刚好够备份。</p>
<p>然后信心十足地格式化磁盘，重装了一个非常干净的Mac OS X Yosemite。重装完系统以后，安装了一些必要的软件之后，再次连接了前面用来备份TimeMachine的移动硬盘，开始复制出一些必要的工作文件，开始一天的工作。<strong>顺便把新安装的Yosemite系统也做了一次TimeMachine备份。。。就此悲剧拉开帷幕！！！</strong></p>
<p>中午吃完饭，看了一眼电脑。发现TimeMachine又开始定时备份了，这时还没有意识到问题。但是突然发现，用于备份TimeMachine的移动硬盘居然空出了300多G的空间。这意味着有备份数据被删除了。</p>
<p>马上看了一下 TimeMachine 备份，果然，最初做的一次备份，也就是在重装操作系统之前做的一次全系统备份数据丢失了 – <strong>这可是唯一的完整数据备份</strong>，我原先计划是重装完系统后，再慢慢从TimeMachine备份中逐步复制恢复数据，顺便整理一下以往的文档。</p>
<p>现在悲剧了，原先我完全信任TimeMachine的完整备份能力，只做了这次镜像备份就没有再创建其他备份副本。这意味着可能数据丢失。</p>
<h1 id="u60B2_u5267_u7684_u539F_u56E0"><a href="#u60B2_u5267_u7684_u539F_u56E0" class="headerlink" title="悲剧的原因"></a>悲剧的原因</h1><p>导致TimeMachine最全面的一份备份被删除的原因是：<strong>TimeMachine在磁盘爆满的情况下会删除掉最陈旧的备份</strong>，这个特性其实在TimeMachine的<code>Performance</code>设置中有说明</p>
<p><img src="/img/mac/timemachine_delete_oldest_backup.png" alt="TimeMachine"></p>
<blockquote>
<p>这个删除最旧备份的策略在通常情况下是有效的，因为如果对一个Mac主机持续备份，一般情况下最需要保留的是最近几次备份；并且通常情况下，系统中的文件变化是有限的，最近几次备份已经能够满足有效的文件追溯。</p>
</blockquote>
<p>但是，这次的经验教训是：</p>
<ul>
<li>同一个（有限容量的）存储不要同时提供两个或两个以上的主机做TimeMachine，因为主机的第一次备份是全备份，很有可能会把磁盘撑爆，导致TimeMachine删除掉旧备份，也就是你最近做的一次全备份</li>
<li>TimeMachine不是万能的，不能取代常规的备份 - 特别是磁盘空间有限且文件变化极大的环境。因为你无法控制某个时间的快照何时因为磁盘爆满而被删除。总之，磁盘空间要有富足，并且要有告警措施，确保磁盘空间在一定阀值时通知你进行干预处理。</li>
</ul>
<h1 id="u633D_u6551"><a href="#u633D_u6551" class="headerlink" title="挽救"></a>挽救</h1><p>当TimeMachine再创建新的备份并不断覆盖数据的时候，要果断终止备份，这样先前删除的快照如果没有被覆盖，还有可能通过数据修复软件进行恢复。</p>
<p>数据是无价的，毕竟自己积累的家庭照片等等可能在很多年以后有无法估量的价值。所以，花费了99刀购买了<a href="http://www.prosofteng.com/products/data_rescue.php" target="_blank" rel="external">Data Rescue 4</a>进行数据扫描修复，挽回了一些损失。</p>
<hr>
<h1 id="TimeMachine_u539F_u7406"><a href="#TimeMachine_u539F_u7406" class="headerlink" title="TimeMachine原理"></a>TimeMachine原理</h1><p>既然因为对 TimeMachine 机制理解不足导致盲目信任丢失了数据，那就好好学习一下 - 以下是搜集的相关知识点，参考 <a href="http://irising.me/2013/12/17723/" target="_blank" rel="external">全面认识Mac的Time Machine</a> – <strong>强烈推荐此文，原理和实践写得条理清晰</strong></p>
<blockquote>
<p>第一次启动Time Machine以后，软件会对整个整磁盘做一个完整备份，以后每个小时，Time Machine通过Mac OS X系统的FSEvents(文件系统事件)进程对系统的所有变化进行持续的追踪。当发现过去一小时的系统发生变化以后，Time Machine对那些变化的文件进行备份，属于渐进备份(incremental backup)。以后每天会将头一天的小时备份自动清除，每周会将上一周的每天备份自动清除。这样在它节约了备份空间的同时，保持了一套完整的系统备份。</p>
<p>“在MacBook Air等苹果笔记本电脑里，若电脑没有连上Time Machine硬盘（或超出了Time Capsule的无线信号覆盖范围），系统可以智能地把文件临时备份到电脑的本地硬盘上。我们称新建的备份文件为“快照”。” </p>
<p>进入 Time Machine 浏览器（用于恢复数据）后，本地快照将与常规备份一起显示在时间线上，二者以不同颜色加以区分。灰色刻度标记代表本地快照，粉色刻度标记代表存储在外置备份磁盘或 Time Capsule 中的备份。注：如果笔记本电脑未连接到外置备份磁盘或 Time Capsule，则粉色刻度标记将变暗。</p>
<p>若要进行系统恢复，重新启动您的 Mac，并按下 Command 键和 R 键 (Command-R)，然后使用“从 Time Machine 备份进行恢复”实用工具，选择“从Time Machine”恢复，然后依照指示操作。</p>
</blockquote>
<h2 id="u652F_u6301Time_Machine_u7684_u8F6F_u4EF6"><a href="#u652F_u6301Time_Machine_u7684_u8F6F_u4EF6" class="headerlink" title="支持Time Machine的软件"></a>支持Time Machine的软件</h2><blockquote>
<p>Apple自带的软件iWork套件、文本编辑都支持Time Machine的存储模式，可以“进入Time Machine”恢复到先前的版本。第三方的软件也有不少支持，例如：Pixelmator、OmniGraffle、Scapple、PlistEdit Pro等。支持版本管理的这些软件都有一个特征，就是点击标题栏文件名可以进行重命名。</p>
<p>文档快照默认的存储周期是1小时，编辑过程中如果主动“command+s”进行保存，也会存储到Time machine中。盒盖休眠或者是正常关机，系统会自动保存最后的文档状态。</p>
<p>另外因为有本地快照的缘故，即便是没有连接到备份硬盘，系统依旧能访问本地快照中的版本历史记录。除了点击恢复来恢复整个文档以外，在历史版本和当前版本之间还可以通过复制和粘贴来修改内容。</p>
</blockquote>
<h2 id="u6392_u9664_u5728Time_Machine_u4E4B_u5916"><a href="#u6392_u9664_u5728Time_Machine_u4E4B_u5916" class="headerlink" title="排除在Time Machine之外"></a>排除在Time Machine之外</h2><blockquote>
<p>Time Machine使用FSEvents，不需要扫描硬盘，备份时使用的系统资源较少。FSEvents会按照时间周期定时对发生变更的单个文件重新备份，这导致Time Machine遇到类似于虚拟机这样的超大单个文件时会非常占用空间。</p>
<p>iPhoto、Aperture、Papers、DEVONthink Pro这样以库为存储单位的软件，面对Time Machine时也是个问题，Apple自家的iPhoto和Aperture库要好一些，不会因为几张照片的变化而备份整个的库，不过有网友也反应过在迁移向导的还原操作中Aperture出现的Bug，Aperture库还原的只是增量备份的部分，并不完整。</p>
<p>如果备份磁盘空间有限，面对这些文件时需要将它们排除在Time Machine的备份之外。</p>
<p>另外下载目录更像是个临时目录，其中的内容每天变化很多，而且多数没有备份的意义，所以这个也可以排除在备份之外。</p>
</blockquote>

            
                

            
        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">標籤</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/Mac/">Mac</a>

            </div>
        
        <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2014/10/26/regenerating-all-certificates-for-puppet/"  data-tooltip="重建Puppet部署的证书">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2014/10/26/create-glusterfs-high-performance-strpied-volume/" data-tooltip="创建glusterfs的高性能striped卷">
                
                    <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://blog.huatai.me/2014/10/26/warning-timemachine-will-delete-the-oldest-backups-when-disk-becomes-full/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://blog.huatai.me/2014/10/26/warning-timemachine-will-delete-the-oldest-backups-when-disk-becomes-full/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://blog.huatai.me/2014/10/26/warning-timemachine-will-delete-the-oldest-backups-when-disk-becomes-full/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>


        
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2016 阿泰. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2014/10/26/regenerating-all-certificates-for-puppet/"  data-tooltip="重建Puppet部署的证书">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2014/10/26/create-glusterfs-high-performance-strpied-volume/" data-tooltip="创建glusterfs的高性能striped卷">
                
                    <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://blog.huatai.me/2014/10/26/warning-timemachine-will-delete-the-oldest-backups-when-disk-becomes-full/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://blog.huatai.me/2014/10/26/warning-timemachine-will-delete-the-oldest-backups-when-disk-becomes-full/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://blog.huatai.me/2014/10/26/warning-timemachine-will-delete-the-oldest-backups-when-disk-becomes-full/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                <div id="share-options-bar" class="share-options-bar" data-behavior="4">
    <ul class="share-options">
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=http://blog.huatai.me/2014/10/26/warning-timemachine-will-delete-the-oldest-backups-when-disk-becomes-full/">
                <i class="fa fa-google-plus"></i><span class="">分享到 Google+</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://blog.huatai.me/2014/10/26/warning-timemachine-will-delete-the-oldest-backups-when-disk-becomes-full/">
                <i class="fa fa-facebook-official"></i><span>分享到 Facebook</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=http://blog.huatai.me/2014/10/26/warning-timemachine-will-delete-the-oldest-backups-when-disk-becomes-full/">
                <i class="fa fa-twitter"></i><span>分享到 Twitter</span>
            </a>
        </li>
    </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
            
        </div>
        


<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <h4 id="about-card-name">阿泰</h4>
        
            <h5 id="about-card-bio"><p>author.bio</p>
</h5>
        
        
            <h5 id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>author.job</p>

            </h5>
        
        
    </div>
</div>

        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
    </body>
    <!--SCRIPTS-->
<script src="/assets/js/scrip-gfmrkxcl0qohe3cfdgxhzvc0yrceqta8i4iix0txvn8q4o2adlqd5n0jmkvt.min.js" type="text/javascript"></script>
<!--SCRIPTS END-->

    



</html>
